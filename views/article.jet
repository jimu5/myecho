<!DOCTYPE html>
<html lang="zh-hans">

<head>
  <title>{{ Settings.GetStringValue("SiteTitle") }} - {{ Data.Title }}</title>
  {{ include "components/common_head" }}
</head>

<body>
  {{ include "components/header" }}
  <div class="article" onmousedown="articleClick(event)">
    <h1 class="article-title">
      {{ Data.Title }}
    </h1>
    <div class="article-content" id="article_content"></div>
    <div class="article-outline" id="article_outline"></div>
    <div style="display: none" id="raw_content">{{ Data.Detail.Content | raw }}</div>
    <script>
      rawContentNode = document.getElementById("raw_content")
      content = rawContentNode.innerText
      Vditor.preview(document.getElementById("article_content"), content, {
        anchor: 1,
        hljs: {
          enable: true
        },
        after: function () {
          Vditor.outlineRender(document.getElementById("article_content"), document.getElementById("article_outline"));
          initOutline();
        }
      })
      rawContentNode.remove()
    </script>
  </div>
  {{ include "components/footer" RequestTimeDuration }}
</body>

<script type="text/javascript">
  function articleClick(e) {
    if (e.target.tagName == "IMG") {
      Vditor.previewImage(e.target)
    }
  }

  const initOutline = () => {
    const headingElements = []
    Array.from(document.getElementById("article_content").children).forEach((item) => {
      if (item.tagName.length == 2 && item.tagName !== 'HR' && item.tagName.indexOf('H') === 0) {
        headingElements.push(item)
      }
    })
    let toc = []
    window.addEventListener('scroll', () => {
      const scrollTop = window.scrollY
      toc = []
      headingElements.forEach((item) => {
        toc.push({
          id: item.id,
          offsetTop: item.offsetTop,
        })
      })

      const currentElement = document.querySelector('.vditor-outline__item--current')
      for (let i = 0, iMax = toc.length; i < iMax; i++) {
        if (scrollTop < toc[i].offsetTop - 30) {
          if (currentElement) {
            currentElement.classList.remove('vditor-outline__item--current')
          }
          let index = i >0 ? i - 1 : 0
          document.querySelector('span[data-target-id="' + toc[index].id + '"]').classList.add('vditor-outline__item--current')
          break
        }
      }
    })
  }
</script>

</html>